@startuml
autonumber
actor N as "Người dùng"
boundary V as "View: Trang thanh toán"
control C as "Chức năng: Xử lý thanh toán, đơn hàng"
database Cart as "Cơ sở dữ liệu: Giỏ hàng"
database O as "Cơ sở dữ liệu: Đơn hàng"
database OI as "Cơ sở dữ liệu: Dòng đơn hàng"
database Pay as "Cơ sở dữ liệu: Thanh toán"

== Mở form thanh toán ==
N -> V : Đi tới trang thanh toán
activate V
V -> C : Yêu cầu dữ liệu để thanh toán
deactivate V
activate C
C -> Cart : Lấy các dòng giỏ + tính tổng tiền
activate Cart
Cart --> C : Danh sách + tổng tiền
deactivate Cart
alt Giỏ trống
  C --> N : Quay lại giỏ hàng và báo lỗi
  deactivate C
else Có sản phẩm
  C -> V : Hiển thị biểu mẫu thanh toán
  deactivate C
  activate V
  V --> N : Nhập địa chỉ, liên hệ, cách thanh toán
  deactivate V
end

== Gửi đặt hàng ==
N -> V : Xác nhận đặt hàng
activate V
V -> C : Xử lý đặt hàng
deactivate V
activate C
C -> C : Kiểm tra thông tin; yêu cầu mã tham chiếu khi trả qua thẻ/ngân hàng
C -> Cart : Lấy lại dữ liệu để đảm bảo chính xác
activate Cart
Cart --> C : Dữ liệu giỏ hiện tại
deactivate Cart
C -> O : Tạo đơn hàng trạng thái “Chờ xác nhận”
activate O
O --> C : Mã đơn hàng
deactivate O
loop Với mỗi sản phẩm trong giỏ
  C -> OI : Tạo dòng đơn hàng (sản phẩm, số lượng, giá)
end
C -> Pay : Tạo bản ghi thanh toán “Chờ xác nhận”
C -> Cart : Xóa các dòng trong giỏ
C --> N : Chuyển đến màn hình chờ xác nhận đơn
deactivate C

== Xuất hóa đơn ==
C -> Pay : Xuất hóa đơn thanh toán
activate Pay
Pay --> C : Thông tin hóa đơn
deactivate Pay
C -> V : Hiển thị hóa đơn cho người dùng
activate V
V --> N : Hiển thị chi tiết hóa đơn
deactivate V
@enduml